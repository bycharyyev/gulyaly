generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id                String             @id @default(cuid())
  email             String?            @unique
  phone             String?            @unique
  otp               String?
  otpExpiresAt      DateTime?
  otpType           String?
  emailVerified     Boolean            @default(false)
  phoneVerified     Boolean            @default(false)
  name              String?
  avatar            String?
  role              String             @default("USER")
  isActive          Boolean            @default(true)
  banned            Boolean            @default(false)
  bannedReason      String?
  bannedAt          DateTime?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  lastLoginAt       DateTime?
  addresses         Address[]
  orders            Order[]
  reviews           Review[]
  sellerApplication SellerApplication?
  supportMessages   SupportMessage[]

  @@index([email])
  @@index([phone])
  @@index([role])
  @@index([createdAt])
  @@map("users")
}

model Seller {
  id              String        @id @default(cuid())
  email           String        @unique
  passwordHash    String
  name            String
  avatar          String?
  phone           String?
  role            String        @default("SELLER")
  sellerStatus    String        @default("PENDING")
  businessName    String?
  businessType    String?
  taxId           String?
  stripeAccountId String?
  isActive        Boolean       @default(true)
  banned          Boolean       @default(false)
  bannedReason    String?
  bannedAt        DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  lastLoginAt     DateTime?
  stores          Store[]
  transactions    Transaction[] @relation("SellerTransactions")

  @@index([email])
  @@index([role])
  @@index([sellerStatus])
  @@index([createdAt])
  @@map("sellers")
}

model Admin {
  id           String    @id @default(cuid())
  email        String    @unique
  passwordHash String
  name         String
  avatar       String?
  role         String    @default("ADMIN")
  permissions  String    @default("ALL")
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  lastLoginAt  DateTime?

  @@index([email])
  @@index([role])
  @@index([createdAt])
  @@map("admins")
}

model AuthAttempt {
  id            String   @id @default(cuid())
  email         String?
  phone         String?
  ipAddress     String?
  userAgent     String?
  authType      String
  success       Boolean
  failureReason String?
  createdAt     DateTime @default(now())

  @@index([email])
  @@index([phone])
  @@index([ipAddress])
  @@index([createdAt])
  @@index([authType, createdAt])
  @@map("auth_attempts")
}

model Store {
  id          String    @id @default(cuid())
  name        String
  slug        String    @unique
  description String?
  logo        String?
  banner      String?
  isActive    Boolean   @default(true)
  commission  String    @default("0.15")
  ownerId     String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  products    Product[]
  reviews     Review[]
  owner       Seller    @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  @@index([slug])
  @@index([isActive])
  @@index([ownerId])
  @@map("stores")
}

model Product {
  id          String           @id @default(cuid())
  storeId     String?
  name        String
  description String
  image       String?
  isActive    Boolean          @default(false)
  status      String           @default("PENDING_APPROVAL")
  rejectionReason String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  images      String?
  orders      Order[]
  variants    ProductVariant[]
  store       Store?           @relation(fields: [storeId], references: [id])
  reviews     Review[]

  @@index([storeId])
  @@index([isActive])
  @@index([status])
  @@map("products")
}

model ProductVariant {
  id          String   @id @default(cuid())
  productId   String
  name        String
  description String?
  price       Int
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  orders      Order[]
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([isActive])
  @@map("product_variants")
}

model Order {
  id                    String         @id @default(cuid())
  userId                String
  productId             String
  variantId             String
  amount                Int
  status                String         @default("PENDING")
  stripeSessionId       String?
  stripePaymentIntentId String?
  paidAt                DateTime?
  processingStartedAt   DateTime?
  shippedAt             DateTime?
  deliveredAt           DateTime?
  completedAt           DateTime?
  trackingNumber        String?
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt
  dispute               Dispute?
  variant               ProductVariant @relation(fields: [variantId], references: [id])
  product               Product        @relation(fields: [productId], references: [id])
  user                  User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  review                Review?
  transaction           Transaction?

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("orders")
}

model Transaction {
  id                    String   @id @default(cuid())
  orderId               String   @unique
  totalAmount           Int
  platformFee           Int
  sellerAmount          Int
  stripeFee             Int
  status                String   @default("PENDING")
  sellerId              String
  stripePaymentIntentId String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  seller                Seller   @relation("SellerTransactions", fields: [sellerId], references: [id], onDelete: Cascade)
  order                 Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([sellerId])
  @@index([status])
  @@index([createdAt])
  @@map("transactions")
}

model Review {
  id         String   @id @default(cuid())
  userId     String
  orderId    String   @unique
  productId  String
  storeId    String
  rating     Int
  comment    String?
  isVerified Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  store      Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  order      Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([productId])
  @@index([storeId])
  @@index([rating])
  @@map("reviews")
}

model Dispute {
  id          String    @id @default(cuid())
  orderId     String    @unique
  reason      String
  description String
  status      String    @default("OPEN")
  createdBy   String
  resolvedBy  String?
  resolvedAt  DateTime?
  resolution  String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  order       Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([status])
  @@map("disputes")
}

model Address {
  id         String   @id @default(cuid())
  userId     String
  street     String
  city       String
  postalCode String
  country    String   @default("RU")
  isDefault  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("addresses")
}

model SupportMessage {
  id          String   @id @default(cuid())
  userId      String?
  content     String
  isFromAdmin Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@map("support_messages")
}

model WebhookEvent {
  id            String   @id @default(cuid())
  stripeEventId String   @unique
  type          String
  payload       String?
  processedAt   DateTime @default(now())
  status        String   @default("PROCESSED")

  @@index([stripeEventId])
  @@index([type])
  @@index([processedAt])
  @@map("webhook_events")
}

model SellerApplication {
  id              String    @id @default(cuid())
  userId          String    @unique
  status          String    @default("PENDING")
  businessName    String
  businessType    String
  taxId           String?
  phone           String
  email           String
  documents       String?
  reviewedBy      String?
  reviewedAt      DateTime?
  rejectionReason String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("seller_applications")
}
